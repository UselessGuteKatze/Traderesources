//for(var i = 0;i<legend.maps[0].entries.values.length;i++){console.log("[" + legend.maps[0].entries.values[i][0].toFixed(3) + ", " + legend.maps[0].entries.values[i][1].toFixed(3) + ", '#" + (legend.maps[0].entries.colors[i]) + "'],");}

window.gisApp.controls.NdviLegend = function (opt_options) {
    var options = opt_options || {};
    var min = options.min||0;
    var max = options.max||0;

    var legendData;
    if (min < max) {
        legendData = [
            [null, '#880000'], // min
            [null, '#a42700'],
            [null, '#c04f00'],
            [null, '#dd7700'],
            [null, '#e8a400'],
            [null, '#f3d100'],
            [null, '#fefe00'],
            [null, '#d2e800'],
            [null, '#a4d100'],
            [null, '#77bb00'],
            [null, '#4f9900'],
            [null, '#287700'],
            [null, '#005500']]; // max

        var cimax = legendData.length;
        legendData[0][0] = min;
        legendData[Math.round((cimax - 1) / 4)][0] = (max - min) * .25 + min;
        legendData[Math.round((cimax - 1) / 2)][0] = (max - min) * .5 + min;
        legendData[Math.round(3 * (cimax - 1) / 4)][0] = (max - min) * .75 + min;
        legendData[Math.round(cimax - 1)][0] = max;
    } else {
        var palette = window.gisApp.palettes.Ndvi;
        legendData = [
            [0.00, palette.getValColor(0.00)],
            [0.10, palette.getValColor(0.10)],
            [0.20, palette.getValColor(0.20)],
            [0.30, palette.getValColor(0.30)],
            [0.35, palette.getValColor(0.35)],
            [0.40, palette.getValColor(0.40)],
            [0.50, palette.getValColor(0.50)],
            [0.60, palette.getValColor(0.60)],
            [0.70, palette.getValColor(0.70)],
            [0.80, palette.getValColor(0.80)],
            [0.90, palette.getValColor(0.90)],
            [1.00, palette.getValColor(1.00)]
        ];
    }

    var legendStr = "<div class='ndvi-legend-container'><table><tbody>";
    for (var i = legendData.length-1; i >=0 ;i--) {
        legendStr += "<tr><td style='background-color:{0}'>&nbsp;</td><td>{1}</td></tr>".format(legendData[i][1],
            (legendData[i][0] === null) ? "&nbsp;" : legendData[i][0].toFixed(2));
    }
    legendStr += "</tbody></table></div>";

    var $legend = $(legendStr);

    var $element = $("<div class='ndvi-legend ol-unselectable ol-control'>");
    $element.append($legend);

    ol.control.Control.call(this, {
        element: $element[0],
        target: options.target
    });
};
ol.inherits(window.gisApp.controls.NdviLegend, ol.control.Control);


window.gisApp.palettes.Ndvi = window.gisApp.palettes.Ndvi || {
    title: 'Ndvi palette',
    getValColor: function (val) {
        var vcm = this._valColorMap;
        if (vcm[0][0] >= val) {
            return (vcm[0][2]);
        }
        var vcm_last = vcm.length - 1;
        if (vcm[vcm_last][1] <= val) {
            return (vcm[vcm_last][2]);
        }
        for (var i = 0; i < vcm.length; i++) {
            var r = vcm[i];
            if (r[0] <= val && val <= r[1]){
                return (r[2]);
            }
        }
    },
    _valColorMap: [
        [-0.200, -0.100, '#e1e1e1'],
        [-0.100, 0.000, '#e1e1e2'],
        [0.000, 0.005, '#f1ecec'],
        [0.005, 0.010, '#f1eced'],
        [0.010, 0.015, '#efe7e7'],
        [0.015, 0.020, '#efe7e8'],
        [0.020, 0.025, '#ece2e2'],
        [0.025, 0.030, '#ece2e3'],
        [0.030, 0.035, '#e2d8d8'],
        [0.035, 0.040, '#e2d8d9'],
        [0.040, 0.045, '#e1d9d4'],
        [0.045, 0.050, '#e1d9d5'],
        [0.050, 0.055, '#e0dad2'],
        [0.055, 0.060, '#e0dad3'],
        [0.060, 0.065, '#ddd5cb'],
        [0.065, 0.070, '#ddd5cc'],
        [0.070, 0.075, '#e5dbcd'],
        [0.075, 0.080, '#e5dbce'],
        [0.080, 0.085, '#e1d2c5'],
        [0.085, 0.090, '#e1d2c6'],
        [0.090, 0.095, '#dfcec1'],
        [0.095, 0.100, '#dfcec2'],
        [0.100, 0.105, '#ddc9bc'],
        [0.105, 0.110, '#ddc9bd'],
        [0.110, 0.115, '#d7c4b3'],
        [0.115, 0.120, '#d7c4b4'],
        [0.120, 0.125, '#d1c0ab'],
        [0.125, 0.130, '#d1c0ac'],
        [0.130, 0.135, '#cdba9e'],
        [0.135, 0.140, '#cdba9f'],
        [0.140, 0.145, '#c8b5a5'],
        [0.145, 0.150, '#c8b5a6'],
        [0.150, 0.155, '#c0b096'],
        [0.155, 0.160, '#c0b097'],
        [0.160, 0.165, '#b9ab9b'],
        [0.165, 0.170, '#b9ab9c'],
        [0.170, 0.175, '#b4a595'],
        [0.175, 0.180, '#b4a596'],
        [0.180, 0.185, '#b09f8e'],
        [0.185, 0.190, '#b09f8f'],
        [0.190, 0.195, '#b09b89'],
        [0.195, 0.200, '#b09b8a'],
        [0.200, 0.205, '#b19883'],
        [0.205, 0.210, '#b19884'],
        [0.210, 0.215, '#b0957d'],
        [0.215, 0.220, '#b0957e'],
        [0.220, 0.225, '#b09278'],
        [0.225, 0.230, '#b09279'],
        [0.230, 0.235, '#ac8d73'],
        [0.235, 0.240, '#ac8d74'],
        [0.240, 0.245, '#a9896e'],
        [0.245, 0.250, '#a9896f'],
        [0.250, 0.255, '#a58468'],
        [0.255, 0.260, '#a58469'],
        [0.260, 0.265, '#a18063'],
        [0.265, 0.270, '#a18064'],
        [0.270, 0.275, '#9d7c5e'],
        [0.275, 0.280, '#9d7c5f'],
        [0.280, 0.285, '#9a6e59'],
        [0.285, 0.290, '#9a6e5a'],
        [0.290, 0.295, '#965a46'],
        [0.295, 0.300, '#965a47'],
        [0.300, 0.308, '#bfde77'],
        [0.308, 0.315, '#bfde78'],
        [0.315, 0.323, '#b0cf68'],
        [0.323, 0.330, '#b0cf69'],
        [0.330, 0.338, '#a7cc4b'],
        [0.338, 0.345, '#a7cc4c'],
        [0.345, 0.353, '#a4c63d'],
        [0.353, 0.360, '#a4c63e'],
        [0.360, 0.368, '#a0c030'],
        [0.368, 0.375, '#a0c031'],
        [0.375, 0.383, '#96ba20'],
        [0.383, 0.390, '#96ba21'],
        [0.390, 0.398, '#8fb715'],
        [0.398, 0.405, '#8fb716'],
        [0.405, 0.413, '#87b30a'],
        [0.413, 0.420, '#87b30b'],
        [0.420, 0.428, '#80b005'],
        [0.428, 0.435, '#80b006'],
        [0.435, 0.443, '#78ad00'],
        [0.443, 0.450, '#78ad01'],
        [0.450, 0.458, '#6eaa00'],
        [0.458, 0.465, '#6eaa01'],
        [0.465, 0.473, '#64a600'],
        [0.473, 0.480, '#64a601'],
        [0.480, 0.488, '#5da300'],
        [0.488, 0.495, '#5da301'],
        [0.495, 0.503, '#56a100'],
        [0.503, 0.510, '#56a101'],
        [0.510, 0.518, '#529800'],
        [0.518, 0.525, '#529801'],
        [0.525, 0.533, '#539700'],
        [0.533, 0.540, '#539701'],
        [0.540, 0.548, '#4e9400'],
        [0.548, 0.555, '#4e9401'],
        [0.555, 0.563, '#489000'],
        [0.563, 0.570, '#489001'],
        [0.570, 0.578, '#438d00'],
        [0.578, 0.585, '#438d01'],
        [0.585, 0.593, '#3e8a00'],
        [0.593, 0.600, '#3e8a01'],
        [0.600, 0.610, '#398700'],
        [0.610, 0.620, '#398701'],
        [0.620, 0.630, '#338300'],
        [0.630, 0.640, '#338301'],
        [0.640, 0.650, '#2e8000'],
        [0.650, 0.660, '#2e8001'],
        [0.660, 0.670, '#297d00'],
        [0.670, 0.680, '#297d01'],
        [0.680, 0.690, '#217800'],
        [0.690, 0.700, '#217801'],
        [0.700, 0.710, '#1d7500'],
        [0.710, 0.720, '#1d7501'],
        [0.720, 0.730, '#197300'],
        [0.730, 0.740, '#197301'],
        [0.740, 0.750, '#126e00'],
        [0.750, 0.760, '#126e01'],
        [0.760, 0.770, '#0a6900'],
        [0.770, 0.780, '#0a6901'],
        [0.780, 0.790, '#086700'],
        [0.790, 0.800, '#086701'],
        [0.800, 0.810, '#056400'],
        [0.810, 0.820, '#056401'],
        [0.820, 0.830, '#006400'],
        [0.830, 0.840, '#006401'],
        [0.840, 0.850, '#006000'],
        [0.850, 0.860, '#006001'],
        [0.860, 0.870, '#005a00'],
        [0.870, 0.880, '#005a01'],
        [0.880, 0.890, '#005400'],
        [0.890, 0.900, '#005401'],
        [0.900, 0.910, '#004800'],
        [0.910, 0.920, '#004801'],
        [0.920, 0.930, '#003c00'],
        [0.930, 0.940, '#003c01'],
        [0.940, 0.950, '#003600'],
        [0.950, 0.960, '#003601'],
        [0.960, 0.970, '#002400'],
        [0.970, 0.980, '#002401'],
        [0.980, 0.990, '#001800'],
        [0.990, 1.000, '#001801']
    ]
}